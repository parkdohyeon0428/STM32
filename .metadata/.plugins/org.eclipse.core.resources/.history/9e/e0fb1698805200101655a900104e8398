/*
 * ap_main.c
 *
 *  Created on: Jun 19, 2025
 *      Author: rhoblack
 */

#include "ap_main.h"
#include "usart.h"  // printf 사용 시 필요

UltraSonic_TypeDef hultra;

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{

	if(htim->Instance == TIM2) {
		FND_DispDataCallBack();
	}
//		TimeWatch_IncTimeCallBack();
//		StopWatch_IncTimeCallBack();

}

void test_timer_counter()
{
    __HAL_TIM_SET_COUNTER(&htim4, 0); // 카운터 리셋
    HAL_TIM_Base_Start(&htim4);       // 타이머 시작

    HAL_Delay(100);                   // 100ms 대기

    uint32_t cnt = __HAL_TIM_GET_COUNTER(&htim4);
    printf("TIM4 count after 100ms: %lu\r\n", cnt);

    HAL_TIM_Base_Stop(&htim4);        // 타이머 정지
}


void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	if (huart->Instance == USART2) {
		Listener_UartCallBack();
	}
}


int ap_main()
{
	//ap_init();
	MX_TIM4_Init();  // 반
	test_timer_counter();
	HAL_TIM_Base_Start(&htim4);
	HAL_TIM_Base_Start_IT(&htim2);
	HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
//	Motor_SetFreq(10);
//	Motor_Start();
	FND_WriteData(UltraSonic_Calculate(&hultra));
	//FND_WriteData(UltraSonic_Wait_Echo(&hultra));
	while(1)
	{
		FND_WriteData(1111);
		HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_0);
		delay_us(1000000);
		FND_WriteData(0110);
//		Listener_Excute();
//		Controller_Excute();
//		Presenter_Excute();
	}

	return 0;
}

void ap_init()
{
	Listener_Init();
	Presenter_Init();
	Sound_Init();
	Sound_PowerOn();
	Motor_Init(&htim1, TIM_CHANNEL_1);
	UltraSonic_Init(&hultra, GPIOC, GPIO_PIN_7, GPIOA, GPIO_PIN_9);
}



